> [!IMPORTANT]  
> **Upgrading from v1.x?**  
> If you have hifi-wifi v1.3.0 or earlier installed, you MUST uninstall it first:
> ```bash
> cd legacy && sudo ./uninstall.sh && cd ..
> ```

---

## What's New in beta2

This release focuses on **SteamOS reliability** - specifically solving the long-standing issue of build environment persistence across SteamOS updates.

### Homebrew-Based Build Environment (SteamOS)

**The Problem:** SteamOS uses a read-only A/B partition filesystem. Packages installed via `pacman` are wiped on every system update, forcing users to rebuild their development environment repeatedly.

**The Solution:** beta2 now uses [Homebrew](https://brew.sh) for the build toolchain on SteamOS:

| Aspect | Old (pacman) | New (Homebrew) |
|--------|--------------|----------------|
| Install location | `/usr` (wiped on updates) | `/home/linuxbrew/.linuxbrew` (**persists!**) |
| First-time setup | ~5 min (when it worked) | ~10 min |
| After SteamOS update | Full reinstall needed | **Instant** (already there) |
| Reliability | Broken on SteamOS 3.5+ | Works reliably |

**Benefits:**
- Build environment survives all SteamOS updates
- No need to fight the read-only filesystem
- Self-contained GCC toolchain (no system dependencies)
- Same approach works on other immutable distros

### Installer Improvements

- **Complete Refactor**: Installer rewritten for clarity and maintainability
- **Versioned GCC Detection**: Properly finds Homebrew's `gcc-15`/`g++-15` binaries
- **CC Symlinks**: Creates `cc`/`c++` symlinks for Rust's cc crate compatibility
- **Environment Passthrough**: CC/CXX variables properly passed through sudo for cargo builds
- **Pre-Release Warning**: Clear disclaimer that this is testing software

### SteamOS Persistence - The Native Linux Way

**The Problem:** SteamOS wipes `/etc` and `/usr` on every update. Previous approaches tried to fight this:
- tmpfiles.d configs - wiped (lives in /etc)
- System timers with symlinks - wiped  
- Systemd presets - wiped
- Self-repairing symlinks - fragile and dangerous (`steamos-readonly disable`)

**The Solution:** Stop fighting `/usr` - use `$PATH` instead!

| Component | Location | Survives Update? |
|-----------|----------|------------------|
| Binary | `/var/lib/hifi-wifi/hifi-wifi` | ✅ YES (`/var` persists) |
| CLI access | `~/.bashrc` PATH entry | ✅ YES (`/home` persists) |
| User repair service | `~/.config/systemd/user/` | ✅ YES (`/home` persists) |
| System service | `/etc/systemd/system/` | ❌ NO (repaired on boot) |
| Polkit rule | `/etc/polkit-1/rules.d/` | ❌ NO (repaired on boot) |

**How it works:**
1. Installer adds `/var/lib/hifi-wifi` to your `$PATH` in `~/.bashrc`
2. CLI command `hifi-wifi` works because it's in your PATH (no symlinks!)
3. User systemd service runs at boot (via `loginctl enable-linger`)
4. Repair script recreates systemd service file if missing
5. **SteamOS updates become irrelevant** - nothing in `/usr` to wipe!

**Why this is better:**
- No `steamos-readonly disable/enable` cycles
- No fragile symlink self-repair logic
- Works with Game Mode (lingering enabled)
- Standard Linux approach - works on ANY immutable distro

### CAKE QoS Fixes

- **Bandwidth No Longer Stuck at 50Mbit**: Removed throughput-based bandwidth capping that caused a chicken-and-egg problem during speed tests
- **PHY Rate Direct**: Now uses WiFi PHY rate directly for CAKE bandwidth (driver/AP negotiate best rate based on signal quality)

---

## Commits Since beta1

### SteamOS/Homebrew
- `feat(steamos)`: Switch to Homebrew for build toolchain
- `fix(steamos)`: Create cc/c++ symlinks for Rust's cc crate  
- `fix(steamos)`: Pass CC/CXX env vars through sudo for cargo build
- `fix(steamos)`: Find versioned gcc binary (gcc-15 not gcc)
- `fix(steamos)`: Verify gcc works instead of relying on exit code

### Persistence & Bootstrap
- `refactor(steamos)`: Replace symlink approach with PATH in `.bashrc` (native Linux way!)
- `fix(steamos)`: Add user systemd service for auto-repair at boot
- `fix(steamos)`: Enable lingering for Game Mode boot support
- `fix(steamos)`: Remove all `steamos-readonly` disable/enable cycles
- `fix(steamos)`: Simplify bootstrap to only repair systemd service (no symlinks)

### CAKE QoS
- `fix(cake)`: Remove throughput-based bandwidth capping (was causing 50Mbit stuck issue)

### Installer Refactoring
- `refactor(install)`: Complete rewrite for clarity and maintainability
- `fix(install)`: Simplify pacman-key error handling on SteamOS

### Hardware Support
- `fix(steam-deck)`: Add full LCD/OLED support for IRQ and CAKE QoS

### Documentation
- `docs(release)`: Add SteamOS persistence known issue to v3.0.0-beta1
- `docs(release)`: Update beta1 known issue wording

---

## Installation

### Fresh Install
```bash
git clone -b testing https://github.com/doughty247/hifi-wifi.git
cd hifi-wifi
sudo ./install.sh
```

### Upgrade from beta1
```bash
cd ~/hifi-wifi
git fetch origin
git checkout testing
git pull
sudo ./install.sh
```

---

## Testing Checklist

Please verify and report results:

1. **Install**: Does installer complete without errors?
2. **Homebrew** (SteamOS): Does `brew --version` work after install?
3. **CLI Access**: After opening a new terminal, does `hifi-wifi status` work?
4. **Persistence**: Does the service survive a reboot?
5. **SteamOS Update**: After a SteamOS update:
   - Does `hifi-wifi status` still work? (should - PATH is in ~/.bashrc)
   - Does the service auto-repair on login?
6. **Game Mode**: Boot directly into Game Mode - does service start?

**Report Issues:**
```bash
{ hifi-wifi status; journalctl -u hifi-wifi -n 100; } > report.txt
```
Attach `report.txt` to a [GitHub Issue](https://github.com/doughty247/hifi-wifi/issues).

---

## Known Issues

- **GCC Post-Install Warning**: Homebrew may show "post-install step did not complete successfully" - this is harmless and gcc works fine
- **First Build Time**: Initial Homebrew + GCC download takes ~10 minutes on SteamOS
- **New Terminal Required**: After install, open a new terminal for `hifi-wifi` command (PATH needs to reload)

---

## Commands Reference

| Command | Description |
|---------|-------------|
| `hifi-wifi status` | Show optimization state & statistics |
| `sudo hifi-wifi monitor` | Run daemon with live logs |
| `sudo hifi-wifi apply` | Apply optimizations once |
| `sudo hifi-wifi on/off` | Start/Stop service |

---

## Supported Platforms

- **SteamOS 3.x** (Steam Deck LCD/OLED) - Now with persistent builds!
- **Bazzite** (Recommended)
- **Arch Linux**
- **Fedora**
